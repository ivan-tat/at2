// This file is part of Adlib Tracker II (AT2).
//
// OPL3 EMULATOR
// Based on NukedOPL3 1.6 by Nuke.YKT (Alexey Khokholov)
// Special thanks to insane/Altair for initial C to Pascal conversion
//
// SPDX-FileType: SOURCE
// SPDX-FileCopyrightText: 2014-2024 The Adlib Tracker 2 Authors
// SPDX-License-Identifier: GPL-3.0-or-later

#include "defines.h"
#include <stdbool.h>
#include <stdlib.h>
#include "opl3emu.h"

// HINT: (FPC) S-: Stack checking (off)
// HINT: (FPC) Q-: Overflow checking (off)
// HINT: (FPC) R-: Range checking (off)
// HINT: (FPC) V-: Var-string checking (off)
// HINT: (FPC) B-: Complete boolean evaluation (off)
// HINT: (FPC) X+: Extended syntax (ON)
// HINT: (FPC) PACKRECORDS 1: Alignment of record elements (1)

static const uint16_t LOG_SIN_VAL[256] = {
  0x859,0x6C3,0x607,0x58B,0x52E,0x4E4,0x4A6,0x471,0x443,0x41A,0x3F5,0x3D3,0x3B5,0x398,0x37E,0x365,
  0x34E,0x339,0x324,0x311,0x2FF,0x2ED,0x2DC,0x2CD,0x2BD,0x2AF,0x2A0,0x293,0x286,0x279,0x26D,0x261,
  0x256,0x24B,0x240,0x236,0x22C,0x222,0x218,0x20F,0x206,0x1FD,0x1F5,0x1EC,0x1E4,0x1DC,0x1D4,0x1CD,
  0x1C5,0x1BE,0x1B7,0x1B0,0x1A9,0x1A2,0x19B,0x195,0x18F,0x188,0x182,0x17C,0x177,0x171,0x16B,0x166,
  0x160,0x15B,0x155,0x150,0x14B,0x146,0x141,0x13C,0x137,0x133,0x12E,0x129,0x125,0x121,0x11C,0x118,
  0x114,0x10F,0x10B,0x107,0x103,0x0FF,0x0FB,0x0F8,0x0F4,0x0F0,0x0EC,0x0E9,0x0E5,0x0E2,0x0DE,0x0DB,
  0x0D7,0x0D4,0x0D1,0x0CD,0x0CA,0x0C7,0x0C4,0x0C1,0x0BE,0x0BB,0x0B8,0x0B5,0x0B2,0x0AF,0x0AC,0x0A9,
  0x0A7,0x0A4,0x0A1,0x09F,0x09C,0x099,0x097,0x094,0x092,0x08F,0x08D,0x08A,0x088,0x086,0x083,0x081,
  0x07F,0x07D,0x07A,0x078,0x076,0x074,0x072,0x070,0x06E,0x06C,0x06A,0x068,0x066,0x064,0x062,0x060,
  0x05E,0x05C,0x05B,0x059,0x057,0x055,0x053,0x052,0x050,0x04E,0x04D,0x04B,0x04A,0x048,0x046,0x045,
  0x043,0x042,0x040,0x03F,0x03E,0x03C,0x03B,0x039,0x038,0x037,0x035,0x034,0x033,0x031,0x030,0x02F,
  0x02E,0x02D,0x02B,0x02A,0x029,0x028,0x027,0x026,0x025,0x024,0x023,0x022,0x021,0x020,0x01F,0x01E,
  0x01D,0x01C,0x01B,0x01A,0x019,0x018,0x017,0x017,0x016,0x015,0x014,0x014,0x013,0x012,0x011,0x011,
  0x010,0x00F,0x00F,0x00E,0x00D,0x00D,0x00C,0x00C,0x00B,0x00A,0x00A,0x009,0x009,0x008,0x008,0x007,
  0x007,0x007,0x006,0x006,0x005,0x005,0x005,0x004,0x004,0x004,0x003,0x003,0x003,0x002,0x002,0x002,
  0x002,0x001,0x001,0x001,0x001,0x001,0x001,0x001,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000
};

static const uint16_t EXP_VAL[256] = {
  0x000,0x003,0x006,0x008,0x00B,0x00E,0x011,0x014,0x016,0x019,0x01C,0x01F,0x022,0x025,0x028,0x02A,
  0x02D,0x030,0x033,0x036,0x039,0x03C,0x03F,0x042,0x045,0x048,0x04B,0x04E,0x051,0x054,0x057,0x05A,
  0x05D,0x060,0x063,0x066,0x069,0x06C,0x06F,0x072,0x075,0x078,0x07B,0x07E,0x082,0x085,0x088,0x08B,
  0x08E,0x091,0x094,0x098,0x09B,0x09E,0x0A1,0x0A4,0x0A8,0x0AB,0x0AE,0x0B1,0x0B5,0x0B8,0x0BB,0x0BE,
  0x0C2,0x0C5,0x0C8,0x0CC,0x0CF,0x0D2,0x0D6,0x0D9,0x0DC,0x0E0,0x0E3,0x0E7,0x0EA,0x0ED,0x0F1,0x0F4,
  0x0F8,0x0FB,0x0FF,0x102,0x106,0x109,0x10C,0x110,0x114,0x117,0x11B,0x11E,0x122,0x125,0x129,0x12C,
  0x130,0x134,0x137,0x13B,0x13E,0x142,0x146,0x149,0x14D,0x151,0x154,0x158,0x15C,0x160,0x163,0x167,
  0x16B,0x16F,0x172,0x176,0x17A,0x17E,0x181,0x185,0x189,0x18D,0x191,0x195,0x199,0x19C,0x1A0,0x1A4,
  0x1A8,0x1AC,0x1B0,0x1B4,0x1B8,0x1BC,0x1C0,0x1C4,0x1C8,0x1CC,0x1D0,0x1D4,0x1D8,0x1DC,0x1E0,0x1E4,
  0x1E8,0x1EC,0x1F0,0x1F5,0x1F9,0x1FD,0x201,0x205,0x209,0x20E,0x212,0x216,0x21A,0x21E,0x223,0x227,
  0x22B,0x230,0x234,0x238,0x23C,0x241,0x245,0x249,0x24E,0x252,0x257,0x25B,0x25F,0x264,0x268,0x26D,
  0x271,0x276,0x27A,0x27F,0x283,0x288,0x28C,0x291,0x295,0x29A,0x29E,0x2A3,0x2A8,0x2AC,0x2B1,0x2B5,
  0x2BA,0x2BF,0x2C4,0x2C8,0x2CD,0x2D2,0x2D6,0x2DB,0x2E0,0x2E5,0x2E9,0x2EE,0x2F3,0x2F8,0x2FD,0x302,
  0x306,0x30B,0x310,0x315,0x31A,0x31F,0x324,0x329,0x32E,0x333,0x338,0x33D,0x342,0x347,0x34C,0x351,
  0x356,0x35B,0x360,0x365,0x36A,0x370,0x375,0x37A,0x37F,0x384,0x38A,0x38F,0x394,0x399,0x39F,0x3A4,
  0x3A9,0x3AE,0x3B4,0x3B9,0x3BF,0x3C4,0x3C9,0x3CF,0x3D4,0x3DA,0x3DF,0x3E4,0x3EA,0x3EF,0x3F5,0x3FA
};

static const uint8_t MULT_VAL[16] = { 1,2,4,6,8,10,12,14,16,18,20,20,24,24,30,30 };
static const uint8_t KSL_VAL[16] = { 0,32,40,45,48,51,53,55,56,58,59,60,61,62,63,64 };
static const uint8_t KSL_SHIFT[4] = { 8,1,2,0 };
static const uint8_t SL_VAL[16] = { 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,31 };
static const uint8_t VIB_SHIFT[8] = { 3,1,0,1,3,1,0,1 };
static const int8_t  VIB_S_SHIFT[8] = { 1,1,1,1,-1,-1,-1,-1 };
static const uint8_t EG_IDX[16] = { 0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2 };
static const int8_t  EG_SHIFT[16] = { 0,11,10,9,8,7,6,5,4,3,2,1,0,0,-1,-2 };
static const uint8_t EG_VAL[3][4][8] = {
  {
    { 0,0,0,0,0,0,0,0 },
    { 0,0,0,0,0,0,0,0 },
    { 0,0,0,0,0,0,0,0 },
    { 0,0,0,0,0,0,0,0 }
  }, {
    { 0,1,0,1,0,1,0,1 },
    { 0,1,0,1,1,1,0,1 },
    { 0,1,1,1,0,1,1,1 },
    { 0,1,1,1,1,1,1,1 }
  }, {
    { 1,1,1,1,1,1,1,1 },
    { 2,2,1,1,1,1,1,1 },
    { 2,2,1,1,2,2,1,1 },
    { 2,2,2,2,2,2,1,1 }
  }
};

static const uint8_t CH_5BIT_MASK[32] = { 1,2,3,4,5,6,0,0,7,8,9,10,11,12,0,0,13,14,15,16,17,18,0,0,0,0,0,0,0,0,0,0 };
static const uint8_t CH_SLOT_IDX[18] = { 0,1,2,6,7,8,12,13,14,18,19,20,24,25,26,30,31,32 };
static const uint8_t CH_4OP_MASK[18] = { 4,5,6,1,2,3,0,0,0,13,14,15,10,11,12,0,0,0 };
static const uint8_t CH_4OP_IDX[6] = { 0,1,2,9,10,11 };
static const uint8_t CH_MAPPING[18] = {
  3,0,    // 2OP | 4OP #1
  4,1,    // 2OP | 4OP #2
  5,2,    // 2OP | 4OP #3
  6,      // 2OP | RHYTHM: BD
  7,      // 2OP | RHYTHM: HH + SD
  8,      // 2OP | RHYTHM: TT + TC
  12,9,   // 2OP | 4OP #4
  13,10,  // 2OP | 4OP #5
  14,11,  // 2OP | 4OP #6
  15,     // 2OP
  16,     // 2OP
  17};    // 2OP

#define NOISE_HASH_VAL 0x306600
#define NOISE_XOR 0x800302
#define WORD_NULL ((uint16_t) ~0)

typedef enum opl3_chan_type {
  CH_2OP,
  CH_4OP_1,
  CH_4OP_2,
  CH_RHYTHM
} OPL3_CHAN_TYPE;

typedef enum eg_gen_state {
  EG_OFF,
  EG_ATTACK,
  EG_DECAY,
  EG_SUSTAIN,
  EG_RELEASE
} EG_GEN_STATE;

typedef uint32_t *(CHAN_PTR_TABLE)[18];

typedef struct opl3_slot_t {
  struct opl3_chan_t *p_chan;
  struct opl3_chip_t *p_chip;
  int16_t *p_mod;
  uint8_t *p_trem;
  int16_t fb_out;
  int16_t prev_out;
  int16_t output;
  uint32_t pg_phase;
  EG_GEN_STATE eg_state;
  int16_t eg_rout;
  int16_t eg_out;
  uint8_t eg_inc;
  uint8_t eg_rate;
  uint8_t eg_ksl;
  uint8_t reg_vib;
  uint8_t reg_type;
  uint8_t reg_ksr;
  uint8_t reg_mult;
  uint8_t reg_ksl;
  uint8_t reg_tl;
  uint8_t reg_ar;
  uint8_t reg_dr;
  uint8_t reg_sl;
  uint8_t reg_rr;
  uint8_t reg_wf;
  uint8_t key;
} OPL3_SLOT;

typedef struct opl3_chan_t {
  struct opl3_slot_t *p_slot[2];
  struct opl3_chan_t *p_chan;
  struct opl3_chip_t *p_chip;
  int16_t *p_out[4];
  OPL3_CHAN_TYPE ch_type;
  uint16_t fnum;
  uint8_t block;
  uint8_t fb;
  uint8_t con;
  uint8_t alg;
  uint8_t ksr;
  uint16_t out_l;
  uint16_t out_r;
} OPL3_CHAN;

typedef struct opl3_chip_t {
  struct opl3_chan_t chan[18];
  struct opl3_slot_t slot[36];
  uint16_t timer;
  uint8_t nts_bit; // 0 or 1
  uint8_t dva_bit; // 0 or 1
  uint8_t dvb_bit; // 0 or 1
  uint8_t rhy_flag;
  uint8_t trem_dir; // 0 or 1
  uint8_t trem_pos;
  uint8_t trem_val;
  uint8_t vib_pos;
  uint32_t noise;
  int32_t output[2];
  int16_t out_l[18];
  int16_t out_r[18];
  int16_t out_null;
} OPL3_CHIP;

static OPL3_CHIP opl3;

#include "opl3emu/limit_value.c"
#include "opl3emu/envelope_calc_sin.c"
#include "opl3emu/envelope_calc_rate.c"
#include "opl3emu/envelope_update_ksl.c"
#include "opl3emu/envelope_update_rate.c"
#include "opl3emu/envelope_calc.c"
#include "opl3emu/eg_key_on_off.c"
#include "opl3emu/pg_generate.c"
#include "opl3emu/update_lfo_eg_ksr_mult.c"
#include "opl3emu/update_ksl_tl.c"
#include "opl3emu/update_ar_dr.c"
#include "opl3emu/update_sl_rr.c"
#include "opl3emu/slot_generate.c"
#include "opl3emu/slot_calc_fb.c"
#include "opl3emu/chan_set_alg.c"
#include "opl3emu/chan_update_rhythm.c"
#include "opl3emu/update_fnum_block_ksr.c"
#include "opl3emu/update_fb_con.c"
#include "opl3emu/generate_rhythm_slots.c"
#include "opl3emu/update_key.c"
#include "opl3emu/chan_update_4op.c"
#include "opl3emu/chip_generate.c"

#include "opl3emu/OPL3EMU_init.c"
#include "opl3emu/OPL3EMU_WriteReg.c"
#include "opl3emu/OPL3EMU_PollProc.c"
